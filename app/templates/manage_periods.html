{% extends "base.html" %}
{% block title %}Manage Scheduling Periods{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-5">
        <div class="card">
            <div class="card-header">Create New Scheduling Period</div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('main.manage_periods') }}" class="needs-validation" novalidate>
                    <div class="form-group">
                        <label for="period_name">Period Name:</label>
                        <input type="text" class="form-control" id="period_name" name="period_name" placeholder="e.g., Guarding The White House" required>
                        <div class="invalid-feedback">Period name is required.</div>
                    </div>
                    <div class="form-group">
                        <label for="scheduling_period_range">Select Period Start and End Dates:</label>
                        <input type="text" class="form-control" id="scheduling_period_range" name="scheduling_period_range_str" required placeholder="Click to select date range">
                        <div class="invalid-feedback">Please select a date range.</div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="period_start_time">Start Time (on first day):</label>
                            <input type="time" class="form-control" id="period_start_time" name="period_start_time" value="00:00" required>
                             <div class="invalid-feedback">Required.</div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="period_end_time">End Time (on last day):</label>
                            <input type="time" class="form-control" id="period_end_time" name="period_end_time" value="23:59" required>
                            <div class="invalid-feedback">Required.</div>
                        </div>
                    </div>
                    <input type="hidden" id="period_start_date" name="period_start_date">
                    <input type="hidden" id="period_end_date" name="period_end_date">
                    <button type="submit" class="btn btn-primary">Create Period</button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-7">
        <h4>Existing Scheduling Periods</h4>
        {% if periods %}
            <ul class="list-group">
                {% for period in periods %}
                <li class="list-group-item d-flex justify-content-between align-items-center {% if period.id == active_period_id %}active{% endif %}">
                    <div>
                        <strong>{{ period.name }}</strong><br>
                        <small>{{ period.period_start_datetime.strftime('%b %d, %Y %H:%M') }} - {{ period.period_end_datetime.strftime('%b %d, %Y %H:%M') }}</small>
                         <br><small>Shift Templates: {{ period.shift_templates.count() }}, Generated Slots: {{ period.shift_definitions.count() }}</small>
                    </div>
                    <div class="btn-group" role="group">
                        {% if period.id != active_period_id %}
                        <form method="POST" action="{{ url_for('main.set_active_period_action', period_id=period.id) }}" style="display: inline-block; margin-right: 5px;">
                            <button type="submit" class="btn btn-sm btn-success">Set Active</button>
                        </form>
                        {% else %}
                         <span class="btn btn-sm btn-success disabled">Active</span>
                        {% endif %}
                        <a href="{{ url_for('main.define_shift_templates', period_id=period.id) }}" class="btn btn-sm btn-info" style="margin-right: 5px;">Templates/Slots</a>
                        <form method="POST" action="{{ url_for('main.delete_period', period_id=period.id) }}" style="display: inline-block;">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete period \'{{ period.name }}\' and ALL its data?');">Delete</button>
                        </form>
                    </div>
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No scheduling periods created yet.</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const startDateInput = document.getElementById('period_start_date');
    const endDateInput = document.getElementById('period_end_date');
    const rangeInput = document.getElementById('scheduling_period_range');

    const picker = new Litepicker({
        element: rangeInput, singleMode: false, numberOfMonths: 1, format: 'YYYY-MM-DD',
        setup: (p) => {
            p.on('selected', (d1, d2) => {
                if (d1 && d2) {
                    startDateInput.value = d1.format('YYYY-MM-DD');
                    endDateInput.value = d2.format('YYYY-MM-DD');
                    rangeInput.value = `${d1.format('YYYY-MM-DD')} - ${d2.format('YYYY-MM-DD')}`;
                } else { startDateInput.value = ''; endDateInput.value = ''; }
            });
        }
    });
    (function() {'use strict';window.addEventListener('load', function() {
    var forms=document.getElementsByClassName('needs-validation');
    Array.prototype.filter.call(forms,function(f){f.addEventListener('submit',function(e){
    if(f.checkValidity()===false){e.preventDefault();e.stopPropagation();}
    f.classList.add('was-validated');},false);});},false);})();
});
</script>
{% endblock %}