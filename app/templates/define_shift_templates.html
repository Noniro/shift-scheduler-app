{% extends "base.html" %}
{% block title %}Define Shift Templates for {{ period.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <h2>Shift Templates & Coverage Slots for '{{ period.name }}'</h2>
        <p class="lead">Period: <strong>{{ period.period_start_datetime.strftime('%Y-%m-%d %H:%M') }}</strong> to <strong>{{ period.period_end_datetime.strftime('%Y-%m-%d %H:%M') }}</strong>
           (<a href="{{ url_for('main.manage_periods') }}">Change Active Period or Manage Periods</a>)
        </p>
    </div>
</div>

<div class="row">
    <div class="col-md-5">
        <div class="card mb-4">
            <div class="card-header">Add New Shift Template</div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('main.define_shift_templates', period_id=period.id) }}" class="needs-validation" novalidate>
                    <div class="form-group">
                        <label for="template_name">Template Name:</label>
                        <input type="text" class="form-control" id="template_name" name="template_name" placeholder="e.g., 8-Hour Guard Shift" required>
                        <div class="invalid-feedback">Template name is required.</div>
                    </div>
                    <p><strong>Duration:</strong> (Min 20 minutes)</p>
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="duration_days">Days:</label>
                            <input type="number" class="form-control" id="duration_days" name="duration_days" value="0" min="0" max="30" required>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="duration_hours">Hours:</label>
                            <input type="number" class="form-control" id="duration_hours" name="duration_hours" value="8" min="0" max="23" required>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="duration_minutes">Minutes:</label>
                            <input type="number" class="form-control" id="duration_minutes" name="duration_minutes" value="0" min="0" max="59" step="5" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Template</button>
                </form>
            </div>
        </div>

        <h4>Existing Shift Templates <span class="badge badge-secondary">{{ templates|length }}</span></h4>
        {% if templates %}
            <ul class="list-group mb-3">
            {% for template in templates %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>{{ template.name }}</strong><br>
                        <small>Duration:
                            {% if template.duration_days > 0 %}{{ template.duration_days }}d {% endif %}
                            {% if template.duration_hours > 0 %}{{ template.duration_hours }}h {% endif %}
                            {% if template.duration_minutes > 0 %}{{ template.duration_minutes }}m{% endif %}
                            {% if template.duration_days == 0 and template.duration_hours == 0 and template.duration_minutes == 0 %}0m{% endif %}
                        </small>
                    </div>
                    <form method="POST" action="{{ url_for('main.delete_shift_template', period_id=period.id, template_id=template.id) }}" style="display: inline;">
                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Delete template \'{{template.name}}\'? This won\'t delete already generated slots.');">Delete</button>
                    </form>
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p>No shift templates defined for this period yet.</p>
        {% endif %}
    </div>

    <div class="col-md-7">
        <h4>Generate/View Coverage Slots</h4>
        {% if templates %}
            <form method="POST" action="{{ url_for('main.generate_coverage_slots_action', period_id=period.id) }}">
                <button type="submit" class="btn btn-primary btn-lg btn-block mb-3"> <!-- Changed button style -->
                    {% if has_generated_slots %}Re-Generate{% else %}Generate{% endif %} Coverage Slots from Templates
                </button>
                <p class="text-muted small">This will fill the entire period ({{ period.period_start_datetime.strftime('%Y-%m-%d %H:%M') }} to {{ period.period_end_datetime.strftime('%Y-%m-%d %H:%M') }}) by cycling through the defined templates. Existing slots and their assignments for this period will be replaced.</p>
            </form>
        {% else %}
            <p>Add shift templates first to enable generation of coverage slots.</p>
        {% endif %}

        {# Use generated_slots passed from the route #}
        {% if generated_slots %}
            <h5 class="mt-3">Generated Coverage Slots <span class="badge badge-info">{{ generated_slots|length }}</span></h5>
            <div class="list-group" style="max-height: 400px; overflow-y: auto;">
            {% for slot in generated_slots %} {# Iterate over the pre-ordered list #}
                <div class="list-group-item list-group-item-action flex-column align-items-start">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">Slot {{ loop.index }} ({{ slot.name }})</h6>
                        <small>{{ slot.duration_hours_minutes_str }}</small>
                    </div>
                    <p class="mb-1"><small>
                        {{ slot.slot_start_datetime.strftime('%a, %b %d, %Y %I:%M %p') }}
                        <strong>to</strong>
                        {{ slot.slot_end_datetime.strftime('%a, %b %d, %Y %I:%M %p') }}
                    </small></p>
                </div>
            {% endfor %}
            </div>
        {% elif has_generated_slots == false and templates %}
             <p class="mt-3">No coverage slots have been generated yet. Click the button above.</p>
        {% endif %}
    </div>
</div>
<hr>
<a href="{{ url_for('main.index') }}" class="btn btn-success btn-lg mt-3">Done (Go to Home to Add Workers & Generate Schedule)</a>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function() {'use strict';window.addEventListener('load', function() {
var forms=document.getElementsByClassName('needs-validation');
Array.prototype.filter.call(forms,function(f){f.addEventListener('submit',function(e){
if(f.checkValidity()===false){e.preventDefault();e.stopPropagation();}
f.classList.add('was-validated');},false);});},false);})();
</script>
{% endblock %}