{% extends "base.html" %}
{% block title %}Manage Workers {% if active_period %}(for Period: {{ active_period.name }}){% endif %}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-5">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">Add New Worker</div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('main.manage_workers') }}" class="needs-validation" novalidate>
                    <div class="form-group">
                        <label for="worker_name">Worker Name:</label>
                        <input type="text" class="form-control" id="worker_name" name="worker_name" required>
                        <div class="invalid-feedback">Name is required.</div>
                    </div>
                    <div class="form-group">
                        <label for="worker_email">Email (Optional):</label>
                        <input type="email" class="form-control" id="worker_email" name="worker_email">
                        <div class="invalid-feedback">Valid email if provided.</div>
                    </div>
                    <div class="form-group">
                        <label for="max_hours_per_week">Max Hours/Active Period (Optional):</label>
                        <input type="number" class="form-control" id="max_hours_per_week" name="max_hours_per_week" min="0">
                    </div>
                    {% if active_period and all_job_roles_in_active_period %}
                    <div class="form-group">
                        <label>Qualified Roles (for current active period: {{ active_period.name }}):</label>
                        {% for role in all_job_roles_in_active_period %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="qualified_roles" value="{{ role.id }}" id="role_{{ role.id }}_new_{{ worker.id if worker else 'new' }}">
                            <label class="form-check-label" for="role_{{ role.id }}_new_{{ worker.id if worker else 'new' }}">
                                {{ role.name }}
                            </label>
                        </div>
                        {% endfor %}
                        {% if not all_job_roles_in_active_period %}<small class="text-muted">No job roles defined for the active period '{{ active_period.name }}' yet.</small>{% endif %}
                    </div>
                    {% elif active_period %}
                         <p><small class="text-muted">No job roles defined yet for active period '{{ active_period.name }}' to assign qualifications.</small></p>
                    {% else %}
                        <p><small class="text-muted">Set an active period via "Scheduling Periods" page to assign role qualifications.</small></p>
                    {% endif %}
                    <button type="submit" class="btn btn-primary btn-block">Add Worker</button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-7">
        <h4>Existing Workers <span class="badge badge-secondary">{{ workers|length }}</span></h4>
        {% if workers %}
            <ul class="list-group">
            {% for worker_iter in workers %} {# Changed loop variable to avoid conflict with outer 'worker' if any #}
                <li class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ worker_iter.name }}</strong>
                            {% if worker_iter.email %}<small class="text-muted"> ({{ worker_iter.email }})</small>{% endif %}<br>
                            <small>Max Hours/Period: {{ worker_iter.max_hours_per_week if worker_iter.max_hours_per_week is not none else 'N/A' }}</small><br>
                            <small>Constraints: {{ worker_iter.constraints.count() }}</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-info mr-1" data-toggle="modal" data-target="#constraintModal-{{ worker_iter.id }}">Add Unavailability</button>
                            <button class="btn btn-sm btn-warning mr-1" data-toggle="modal" data-target="#rolesModal-{{ worker_iter.id }}">Edit Roles</button>
                            <form method="POST" action="{{ url_for('main.delete_worker', worker_id=worker_iter.id) }}" style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('DELETE worker \'{{ worker_iter.name }}\' and ALL their data? This cannot be undone.');">Delete</button>
                            </form>
                        </div>
                    </div>
                    {% if worker_iter.qualified_roles %}
                        <div class="mt-2">
                            <small><strong>Qualified Roles:</strong> 
                                {% for role in worker_iter.qualified_roles %}
                                    <span class="badge badge-pill badge-light">{{ role.name }} {% if active_period and role.scheduling_period_id != active_period.id %}(from other period){% endif %}</span>
                                {% endfor %}
                            </small>
                        </div>
                    {% endif %}
                </li>

                <!-- Constraint Modal for worker -->
                <div class="modal fade" id="constraintModal-{{ worker_iter.id }}" tabindex="-1" role="dialog">
                    <div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header">
                        <h5 class="modal-title">Unavailability for {{ worker_iter.name }}</h5><button type="button" class="close" data-dismiss="modal">×</button>
                    </div><form method="POST" action="{{ url_for('main.add_constraint', worker_id=worker_iter.id) }}" class="needs-validation" novalidate>
                        <input type="hidden" name="redirect_to" value="{{ url_for('main.manage_workers') }}">
                        <div class="modal-body">
                        <p>Specify dates when {{ worker_iter.name }} is unavailable (whole day).</p>
                        <div class="form-group"><label for="csd_{{worker_iter.id}}">From Date:</label><input type="date" class="form-control" id="csd_{{worker_iter.id}}" name="constraint_start_date" required><div class="invalid-feedback">Required.</div></div>
                        <div class="form-group"><label for="ced_{{worker_iter.id}}">To Date (inclusive):</label><input type="date" class="form-control" id="ced_{{worker_iter.id}}" name="constraint_end_date" required><div class="invalid-feedback">Required.</div></div>
                        </div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button><button type="submit" class="btn btn-primary">Add</button></div></form></div></div>
                </div>

                <!-- Roles Modal for worker -->
                <div class="modal fade" id="rolesModal-{{ worker_iter.id }}" tabindex="-1" role="dialog">
                    <div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header">
                        <h5 class="modal-title">Edit Qualified Roles for {{ worker_iter.name }}</h5><button type="button" class="close" data-dismiss="modal">×</button>
                    </div><form method="POST" action="{{ url_for('main.edit_worker_roles', worker_id=worker_iter.id) }}">
                        <div class="modal-body">
                        {% if active_period and all_job_roles_in_active_period %}
                            <p>Select roles {{ worker_iter.name }} is qualified for (for active period '{{active_period.name}}'):</p>
                            <div class="row">
                            {% for role in all_job_roles_in_active_period %} {# Iterate through roles of active period #}
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="qualified_roles" value="{{ role.id }}" id="role_{{ role.id }}_edit_{{worker_iter.id}}"
                                            {% set worker_role_ids = worker_iter.qualified_roles|map(attribute='id')|list %}
                                            {% if role.id in worker_role_ids %}checked{% endif %}>
                                        <label class="form-check-label" for="role_{{ role.id }}_edit_{{worker_iter.id}}">
                                            {{ role.name }}
                                        </label>
                                    </div>
                                </div>
                            {% endfor %}
                            </div>
                            {% if not all_job_roles_in_active_period %}<small class="text-muted">No job roles defined for active period '{{ active_period.name }}' yet.</small>{% endif %}
                        {% elif active_period %}
                             <p><small class="text-muted">No job roles defined for active period '{{ active_period.name }}' to assign qualifications.</small></p>
                        {% else %}
                            <p class="text-danger">No active scheduling period selected. Please select one from the "Scheduling Periods" page to manage role qualifications.</p>
                        {% endif %}
                        </div><div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            {% if active_period and all_job_roles_in_active_period %}<button type="submit" class="btn btn-primary">Save Roles</button>{% endif %}
                        </div></form></div></div>
                </div>
            {% endfor %}
            </ul>
        {% else %}
            <p>No workers created yet.</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}{{ super() }}
<script>
(function() {'use strict';window.addEventListener('load', function() {
var forms=document.getElementsByClassName('needs-validation');
Array.prototype.filter.call(forms,function(f){f.addEventListener('submit',function(e){
if(f.checkValidity()===false){e.preventDefault();e.stopPropagation();}
f.classList.add('was-validated');},false);});},false);})();
</script>
{% endblock %}