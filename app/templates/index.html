{% extends "base.html" %}
{% block title %}Shift Scheduler Home{% endblock %}

{% block content %}
    {% if not current_user_name %}
        <div class="jumbotron text-center">
            <h1>Welcome to the Shift Scheduler!</h1>
            <p class="lead">Let's get your schedule started.</p>
            <form method="POST" action="{{ url_for('main.set_user_name') }}" class="needs-validation" novalidate>
                <div class="form-group row d-flex justify-content-center">
                    <div class="col-sm-6">
                        <label for="user_name_input" class="sr-only">What's your name, scheduler?</label>
                        <input type="text" class="form-control form-control-lg" id="user_name_input" name="user_name" placeholder="Your Name" required>
                        <div class="invalid-feedback">Please enter your name.</div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-lg mt-3">Let's Go!</button>
            </form>
        </div>
    {% else %} {# User name is set #}
        {% if not active_period %}
            <div class="alert alert-info text-center" role="alert">
                <h4>Welcome, {{ current_user_name }}!</h4>
                <p>Please <a href="{{ url_for('main.manage_periods') }}" class="alert-link">select or create a Scheduling Period</a> to begin.</p>
            </div>
        {% else %} {# Active period is set #}
            <div class="alert alert-primary text-center" role="alert">
                <h4>Active Period: {{ active_period.name }}</h4>
                <p>({{ active_period.period_start_datetime.strftime('%b %d, %Y %H:%M') }} - {{ active_period.period_end_datetime.strftime('%b %d, %Y %H:%M') }})</p>
                <p>
                    <a href="{{ url_for('main.manage_periods') }}" class="btn btn-sm btn-outline-primary">Change Active Period</a>
                    <a href="{{ url_for('main.define_shift_templates', period_id=active_period.id) }}" class="btn btn-sm btn-outline-primary">Define Shift Templates & Generate Slots</a>
                </p>
            </div>

            <div class="row">
                <div class="col-md-4">
                    <h4>Add Worker</h4>
                    <form method="POST" action="{{ url_for('main.add_worker') }}" class="mb-4 needs-validation" novalidate>
                        <div class="form-group">
                            <label for="worker_name">Name:</label>
                            <input type="text" class="form-control" id="worker_name" name="worker_name" required>
                            <div class="invalid-feedback">Worker name is required.</div>
                        </div>
                        <div class="form-group">
                            <label for="worker_email">Email:</label>
                            <input type="email" class="form-control" id="worker_email" name="worker_email" required>
                            <div class="invalid-feedback">Valid email is required.</div>
                        </div>
                        <div class="form-group">
                            <label for="max_hours_per_week">Max Hours for this Period (optional):</label>
                            <input type="number" class="form-control" id="max_hours_per_week" name="max_hours_per_week" min="0">
                        </div>
                        <button type="submit" class="btn btn-primary">Add Worker</button>
                    </form>
                    <hr>
                    <h4>Workers <span class="badge badge-secondary">{{ workers|length }}</span></h4>
                    {% if workers %}
                        <ul class="list-group mb-3">
                        {% for worker in workers %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    {{ worker.name }} <small class="text-muted">({{ worker.email }})</small>
                                    <br><small>Max Hours: {{ worker.max_hours_per_week if worker.max_hours_per_week else 'N/A' }}</small>
                                    <br><small>Constraints: {{ worker.constraints.count() }}</small>
                                </div>
                                <button class="btn btn-sm btn-info" data-toggle="modal" data-target="#constraintModal-{{ worker.id }}">Add Unavailability</button>
                            </li>
                            <!-- Constraint Modal (same as before) -->
                            <div class="modal fade" id="constraintModal-{{ worker.id }}" tabindex="-1" role="dialog">
                              <div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header">
                                <h5 class="modal-title">Unavailability for {{ worker.name }}</h5><button type="button" class="close" data-dismiss="modal">Ã—</button>
                              </div><form method="POST" action="{{ url_for('main.add_constraint', worker_id=worker.id) }}" class="needs-validation" novalidate><div class="modal-body">
                                <p>Specify dates when {{ worker.name }} is unavailable (whole day).</p>
                                <div class="form-group"><label for="csd_{{worker.id}}">From Date:</label><input type="date" class="form-control" id="csd_{{worker.id}}" name="constraint_start_date" required><div class="invalid-feedback">Required.</div></div>
                                <div class="form-group"><label for="ced_{{worker.id}}">To Date (inclusive):</label><input type="date" class="form-control" id="ced_{{worker.id}}" name="constraint_end_date" required><div class="invalid-feedback">Required.</div></div>
                              </div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button><button type="submit" class="btn btn-primary">Add</button></div></form></div></div>
                            </div>
                        {% endfor %}
                        </ul>
                    {% else %}<p>No workers added yet.</p>{% endif %}
                </div>

                <div class="col-md-8">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Schedule for '{{ active_period.name }}'</h4>
                        {% if workers and has_defined_shift_slots %}
                            <form method="POST" action="{{ url_for('main.generate_schedule_route') }}">
                                <button type="submit" class="btn btn-success btn-lg">Generate/Re-Generate Schedule</button>
                            </form>
                        {% elif not has_defined_shift_slots %}
                             <p class="text-warning">Generate coverage slots first to enable schedule generation.</p>
                        {% elif not workers %}
                            <p class="text-warning">Add workers to enable schedule generation.</p>
                        {% endif %}
                    </div>

                    <h5 class="mt-4">Generated Assignments</h5>
                    {% if scheduled_assignments %}
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead><tr><th>Slot Name</th><th>Start</th><th>End</th><th>Duration</th><th>Assigned Worker</th></tr></thead>
                                <tbody>
                                {% for assignment in scheduled_assignments %}
                                    <tr>
                                        <td>{{ assignment.defined_slot.name }}</td>
                                        <td>{{ assignment.defined_slot.slot_start_datetime.strftime('%a, %b %d %H:%M') }}</td>
                                        <td>{{ assignment.defined_slot.slot_end_datetime.strftime('%a, %b %d %H:%M') }}</td>
                                        <td>{{ assignment.defined_slot.duration_hours_minutes_str }}</td>
                                        <td>
                                            {% if assignment.worker_assigned %}{{ assignment.worker_assigned.name }}{% else %}<span class="text-danger">UNASSIGNED</span>{% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% elif has_defined_shift_slots %}
                        <p>Schedule not generated yet for the defined slots.</p>
                    {% else %}
                        <p>No coverage slots have been generated for this period. <a href="{{ url_for('main.define_shift_templates', period_id=active_period.id) }}">Generate slots now</a>.</p>
                    {% endif %}
                </div>
            </div>
        {% endif %} {# end if active_period #}
    {% endif %} {# end if not current_user_name #}
{% endblock %}

{% block scripts %}{{ super() }}<script>
(function() {'use strict';window.addEventListener('load', function() {
var forms=document.getElementsByClassName('needs-validation');
Array.prototype.filter.call(forms,function(form){form.addEventListener('submit',function(event){
if(form.checkValidity()===false){event.preventDefault();event.stopPropagation();}
form.classList.add('was-validated');},false);});},false);})();
</script>{% endblock %}