{% extends "base.html" %}
{% block title %}Dashboard - Shift Scheduler{% endblock %}

{% block content %}
    {% if not current_user_name %}
        <div class="jumbotron text-center">
            <h1>Welcome to the Shift Scheduler!</h1>
            <p class="lead">Let's get your schedule started.</p>
            <form method="POST" action="{{ url_for('main.index') }}" class="needs-validation" novalidate> {# Form posts to index now #}
                <div class="form-group row d-flex justify-content-center">
                    <div class="col-sm-6">
                        <label for="user_name_input" class="sr-only">What's your name, scheduler?</label>
                        <input type="text" class="form-control form-control-lg" id="user_name_input" name="user_name_field" placeholder="Your Name" required>
                        <div class="invalid-feedback">Please enter your name.</div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-lg mt-3">Let's Go!</button>
            </form>
        </div>
    {% else %} {# User name is set #}
        {% if not active_period %}
            <div class="alert alert-info text-center" role="alert">
                <h4>Welcome, {{ current_user_name }}!</h4>
                <p>Please <a href="{{ url_for('main.manage_periods') }}" class="alert-link">select or create a Scheduling Period</a> to begin.</p>
            </div>
        {% else %} {# Active period is set #}
            <div class="alert alert-primary " role="alert">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="alert-heading mb-0">Active Period: {{ active_period.name }}</h4>
                        <p class="mb-0 small">({{ active_period.period_start_datetime.strftime('%b %d, %Y %H:%M') }} - {{ active_period.period_end_datetime.strftime('%b %d, %Y %H:%M') }})</p>
                    </div>
                    <div>
                        <a href="{{ url_for('main.manage_periods') }}" class="btn btn-sm btn-outline-primary mr-2">Change/Manage Periods</a>
                        <a href="{{ url_for('main.manage_job_roles_for_period', period_id=active_period.id) }}" class="btn btn-sm btn-outline-primary">
                            Define Job Roles / Generate Slots & Assignments
                        </a>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Schedule Assignments for '{{ active_period.name }}'</h4>
                        {# "Generate Assignments" button is now part of the Job Roles page workflow #}
                        {% if not workers %}
                            <p class="text-warning mb-0">
                                <a href="{{ url_for('main.manage_workers') }}">Add Workers</a> to enable schedule generation.
                            </p>
                        {% elif not has_defined_shift_slots %}
                             <p class="text-warning mb-0">
                                <a href="{{ url_for('main.manage_job_roles_for_period', period_id=active_period.id) }}">Define Job Roles & Generate Slots</a> first.
                            </p>
                        {% endif %}
                    </div>

                    {% if scheduled_assignments %}
                        <p class="text-muted"><small>Total Assigned Slots: {{ scheduled_assignments|length }}</small></p>
                        <div class="table-responsive">
                            <table class="table table-striped table-sm table-hover">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Role & Instance</th>
                                        <th>Start Time</th>
                                        <th>End Time</th>
                                        <th>Duration</th>
                                        <th>Assigned Worker</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for assignment in scheduled_assignments %}
                                    <tr>
                                        <td>{{ assignment.defined_slot.name }}</td>
                                        <td>{{ assignment.defined_slot.slot_start_datetime.strftime('%a, %b %d, %Y %H:%M') }}</td>
                                        <td>{{ assignment.defined_slot.slot_end_datetime.strftime('%a, %b %d, %H:%M') }}</td>
                                        <td>{{ assignment.defined_slot.duration_hours_minutes_str }}</td>
                                        <td>
                                            {% if assignment.worker_assigned %}
                                                {{ assignment.worker_assigned.name }}
                                            {% else %}
                                                <span class="text-danger font-weight-bold">UNASSIGNED</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% elif has_defined_shift_slots %}
                        <p class="text-center text-muted mt-4">
                            Coverage slots have been generated for this period, but no worker assignments have been made yet.
                            <br>Go to <a href="{{ url_for('main.manage_job_roles_for_period', period_id=active_period.id) }}">Manage Job Roles / Generate Slots & Assignments</a> to (re)generate and assign.
                            <br>Ensure you have <a href="{{ url_for('main.manage_workers') }}">added workers</a> and set their role qualifications and unavailability.
                        </p>
                    {% else %}
                        <p class="text-center text-muted mt-4">
                            No coverage slots have been generated for this period yet.
                            <br>Start by going to <a href="{{ url_for('main.manage_job_roles_for_period', period_id=active_period.id) }}">Define Job Roles & Generate Slots</a>.
                        </p>
                    {% endif %}
                </div>
            </div>
        {% endif %} {# end if active_period #}
    {% endif %} {# end if not current_user_name #}
{% endblock %}

{% block scripts %}{{ super() }}<script>
(function() {'use strict';window.addEventListener('load', function() {
var forms=document.getElementsByClassName('needs-validation');
Array.prototype.filter.call(forms,function(form){form.addEventListener('submit',function(event){
if(form.checkValidity()===false){event.preventDefault();event.stopPropagation();}
form.classList.add('was-validated');},false);});},false);})();
</script>{% endblock %}