{% extends "base.html" %}
{% block title %}Fairness Statistics for {{ period.name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h2>Fairness Statistics</h2>
        <p class="lead mb-0">For Scheduling Period: <strong>{{ period.name }}</strong></p>
        <small>({{ period.period_start_datetime.strftime('%b %d, %Y %H:%M') }} - {{ period.period_end_datetime.strftime('%b %d, %Y %H:%M') }})</small>
    </div>
    <a href="{{ url_for('main.index') }}" class="btn btn-outline-primary">Back to Dashboard</a>
</div>

<!-- Overall Statistics -->
<div class="card mb-4">
    <div class="card-header">
        <h4>Overall Period Statistics</h4>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body">
                        <h5 class="card-title">Total Shifts</h5>
                        <p class="card-text display-4">{{ stats.total_shifts }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body">
                        <h5 class="card-title">Assigned Shifts</h5>
                        <p class="card-text display-4 text-success">{{ stats.assigned_shifts }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body">
                        <h5 class="card-title">Unassigned Shifts</h5>
                        <p class="card-text display-4 text-danger">{{ stats.unassigned_shifts }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart Visualizations -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5>Night Shifts per Worker</h5>
            </div>
            <div class="card-body"><canvas id="nightShiftsChart"></canvas></div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5>Shifts by Difficulty per Worker</h5>
            </div>
            <div class="card-body"><canvas id="difficultyDistributionChart"></canvas></div>
        </div>
    </div>
</div>


<!-- Worker Statistics -->
<div class="card mb-4">
    <div class="card-header">
        <h4>Worker Statistics</h4>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
                <thead class="thead-dark">
                    <tr>
                        <th>Worker</th>
                        <th>Total Shifts</th>
                        <th>Total Hours</th>
                        <th>Night Shifts</th>
                        <th>Shifts by Difficulty (Easy/Light/Mod./Hard/V.Hard)</th>
                        <th>Downtime (Hours)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for worker_stat in stats.worker_stats.values() %}
                    <tr>
                        <td><strong>{{ worker_stat.name }}</strong></td>
                        <td>{{ worker_stat.total_shifts }}</td>
                        <td>{{ "%.2f"|format(worker_stat.total_hours) }}</td>
                        <td>{{ worker_stat.night_shifts }}</td>
                        <td>
                            <span class="badge badge-success" title="Easy (1)">{{ worker_stat.difficulty_counts[1] }}</span> /
                            <span class="badge badge-info" title="Light (2)">{{ worker_stat.difficulty_counts[2] }}</span> /
                            <span class="badge badge-warning" title="Moderate (3)">{{ worker_stat.difficulty_counts[3] }}</span> /
                            <span class="badge badge-danger" title="Hard (4)">{{ worker_stat.difficulty_counts[4] }}</span> /
                            <span class="badge badge-dark" title="Very Hard (5)">{{ worker_stat.difficulty_counts[5] }}</span>
                        </td>
                        <td>{{ "%.2f"|format(worker_stat.downtime_hours) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Job Role Statistics -->
<div class="card mb-4">
    <div class="card-header">
        <h4>Job Role Statistics</h4>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
                <thead class="thead-dark">
                    <tr>
                        <th>Job Role</th>
                        <th>Total Shifts</th>
                        <th>Total Hours</th>
                        <th>Unique Workers</th>
                        <th>Worker Distribution</th>
                    </tr>
                </thead>
                <tbody>
                    {% for role_stat in stats.role_stats.values() %}
                    <tr>
                        <td><strong>{{ role_stat.name }}</strong></td>
                        <td>{{ role_stat.total_shifts }}</td>
                        <td>{{ "%.2f"|format(role_stat.total_hours) }}</td>
                        <td>{{ role_stat.unique_workers }}</td>
                        <td>
                            {% for worker_name, count in role_stat.worker_distribution.items() %}
                                <span class="badge badge-light">{{ worker_name }}: {{ count }}</span>
                            {% else %}
                                <span class="text-muted">No assignments</span>
                            {% endfor %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Unassigned Shifts -->
{% if stats.unassigned_shifts_list %}
<div class="card mb-4">
    <div class="card-header">
        <h4>Unassigned Shifts Details</h4>
    </div>
    <div class="card-body">
        <ul class="list-group">
            {% for shift in stats.unassigned_shifts_list %}
                <li class="list-group-item">
                    <strong>{{ shift.defined_slot.name }}</strong>: 
                    {{ shift.defined_slot.slot_start_datetime.strftime('%a, %b %d, %Y %H:%M') }} to 
                    {{ shift.defined_slot.slot_end_datetime.strftime('%H:%M') }}
                    ({{ shift.defined_slot.duration_hours_minutes_str }})
                </li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- 1. Include the Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- 2. Your custom scripts for this page -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get the comprehensive stats object from Flask
    const statsData = JSON.parse('{{ stats|tojson|safe }}');
    const workers = Object.values(statsData.worker_stats);

    // --- Chart 1: Night Shifts per Worker ---
    const nightShiftsCanvas = document.getElementById('nightShiftsChart');
    if (nightShiftsCanvas && workers.length > 0) {
        const labels = workers.map(w => w.name);
        const nightShiftCounts = workers.map(w => w.night_shifts);

        new Chart(nightShiftsCanvas, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Night Shifts Assigned',
                    data: nightShiftCounts,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1 // Ensure y-axis shows whole numbers for shift counts
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: 'Count of Shifts Between 00:00 - 06:00'
                    }
                }
            }
        });
    }

    // --- Chart 2: Difficulty Distribution per Worker (Stacked Bar) ---
    const difficultyCanvas = document.getElementById('difficultyDistributionChart');
    if (difficultyCanvas && workers.length > 0) {
        const labels = workers.map(w => w.name);
        
        const difficultyLevels = [
            { label: 'Easy/Regular (1)', color: 'rgba(40, 167, 69, 0.7)', key: 1 },
            { label: 'Light (2)', color: 'rgba(23, 162, 184, 0.7)', key: 2 },
            { label: 'Moderate (3)', color: 'rgba(255, 193, 7, 0.7)', key: 3 },
            { label: 'Hard (4)', color: 'rgba(220, 53, 69, 0.7)', key: 4 },
            { label: 'Very Hard (5)', color: 'rgba(52, 58, 64, 0.7)', key: 5 }
        ];

        const datasets = difficultyLevels.map(level => {
            return {
                label: level.label,
                data: workers.map(w => w.difficulty_counts[level.key]),
                backgroundColor: level.color
            };
        });

        new Chart(difficultyCanvas, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                plugins: {
                    title: {
                        display: true,
                        text: 'Distribution of Shift Difficulty Levels per Worker'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                responsive: true,
                scales: {
                    x: {
                        stacked: true, // Stack bars on the x-axis
                    },
                    y: {
                        stacked: true, // Stack bars on the y-axis
                        beginAtZero: true,
                         ticks: {
                            stepSize: 1
                        },
                        title: {
                            display: true,
                            text: 'Total Number of Shifts'
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}